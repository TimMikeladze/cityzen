<!DOCTYPE html>
<html>
<head>
<style>
body { margin: 0; overflow: hidden; }
canvas { background-color: #99ddaa; }
</style>
<script type="text/javascript">
window.onload = () => {
  'use strict'

  var _canvas = document.getElementById('canvas')
  var _context = _canvas.getContext('2d')
  var _endX
  var _endY
  var _isDragging = false
  var _isRotating = false
  var _rotation = Math.PI / 10
  var _startX
  var _startY

  var _clearCanvas = () => {
    _canvas.width = _canvas.width
  }

  var _distance = (startX, startY, endX, endY) => {
    var diffX = Math.abs(startX - endX)
    var diffY = Math.abs(startY - endY)
    var distance = Math.sqrt(diffX * diffX + diffY * diffY)
    return distance
  }

  var _dimensions = (mouseX, mouseY) => {
    var x, y
    var z = _distance(_startX, _startY, mouseX, mouseY)
    var d = mouseX - _startX
    var theta = Math.acos(d / z)
    if (mouseY > _startY) {
      var phi = theta - _rotation
      x = z * Math.cos(phi)
      y = z * Math.sin(phi)
    } else {
      var phi = theta + _rotation
      x = z * Math.cos(phi)
      y = -z * Math.sin(phi)
    }
    return {x:x,y:y}
  }

  var _start = () => {
    var d = _distance(0, 0, _startX, _startY)
    var theta = Math.PI / 2 - _rotation / 2
    var z = 2 * d * Math.cos(theta)
    var phi = Math.PI - theta - Math.acos(_startX / d)
    var x = _startX + z * Math.cos(phi)
    var y = _startY - z * Math.sin(phi)
    return {x:x,y:y}
  }


  /* Initialization */

  _canvas.height = window.innerHeight
  _canvas.width = window.innerWidth


  /* Event bindings */

  _canvas.addEventListener('mousedown', (event) => {
    _startX = event.x
    _startY = event.y
    _isDragging = true
  })

  _canvas.addEventListener('mousemove', (event) => {
    if (_isDragging) {
      _clearCanvas()
      if (_isRotating) {
         _endX =  _endX || event.x
         _endY =  _endY || event.y
        // TODO Alex - Set the rotation dynamically based on user input
      } else {
        _endX = event.x
        _endY = event.y
      }
      _context.rotate(_rotation)
      _context.fillStyle = 'rgba(100,100,100,0.5)'
      var start = _start()
      var dimensions = _dimensions(event.x, event.y)
      _context.fillRect(start.x, start.y, dimensions.x, dimensions.y)
    }
  })

  _canvas.addEventListener('mouseup', (event) => {
    _isDragging = false
    _endX = undefined
    _endY = undefined
  })

  window.addEventListener('keydown', (event) => {
    if (event.ctrlKey) {
      _isRotating = true
    }
  })

  window.addEventListener('keyup', (event) => {
    _isRotating = false
  })

}
</script>  
</head>
<body>
<canvas id="canvas">
</canvas>  
</body>
</html>