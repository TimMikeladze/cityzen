<!DOCTYPE html>
<html>
<head>
<style>
body { margin: 0; overflow: hidden; }
canvas { background-color: #99ddaa; }
</style>
<script type="text/javascript">
window.onload = () => {
  'use strict'

  var _canvas = document.getElementById('canvas')
  var _context = _canvas.getContext('2d')
  var _endX
  var _endY
  var _isDragging = false
  var _isRotating = false
  var _rotation = Math.PI / 10
  var _startX
  var _startY

  var _clearCanvas = () => {
    _canvas.width = _canvas.width
  }

  var _distance = (startX, startY, endX, endY) => {
    var diffX = Math.abs(startX - endX)
    var diffY = Math.abs(startY - endY)
    var distance = Math.sqrt(diffX * diffX + diffY * diffY)
    return distance
  }

  var _dimensions = (endX, endY) => {
    var x, y
    var z = _distance(_startX, _startY, endX, endY)
    var d = endX - _startX
    var theta = Math.acos(d / z)
    if (endY > _startY) {
      var phi = theta - _rotation
      x = z * Math.cos(phi)
      y = z * Math.sin(phi)
    } else {
      var phi = theta + _rotation
      x = z * Math.cos(phi)
      y = -z * Math.sin(phi)
    }
    return {x:x,y:y}
  }

  var _start = () => {
    var d = _distance(0, 0, _startX, _startY)
    var theta = Math.PI / 2 - _rotation / 2
    var z = 2 * d * Math.cos(theta)
    var phi = Math.PI - theta - Math.acos(_startX / d)
    var x = _startX + z * Math.cos(phi)
    var y = _startY - z * Math.sin(phi)
    return {x:x,y:y}
  }


  /* Initialization */

  _canvas.height = window.innerHeight
  _canvas.width = window.innerWidth


  /* Event bindings */

  _canvas.addEventListener('mousedown', (event) => {
    _startX = event.x
    _startY = event.y
    _isDragging = true
    // Draw the anchor
    _clearCanvas()
    _context.beginPath()
    _context.fillStyle = 'rgba(20,200,80,0.5)'
    _context.arc(event.x, event.y, 10, 0, 2 * Math.PI)
    _context.fill()
  })

  _canvas.addEventListener('mousemove', (event) => {

    // Set the end point or the rotation angle, if dragging
    if (_isDragging) {
      if (_isRotating) {
         _endX = _endX || event.x
         _endY = _endY || event.y
        // TODO Alex - Set the rotation dynamically based on user input
      } else {
        _endX = event.x
        _endY = event.y
      }
    }

    // Draw the rotated rectangle
    _clearCanvas()
    _context.save()
    _context.rotate(_rotation)
    _context.fillStyle = 'rgba(100,100,100,0.5)'
    var start = _start()
    var dimensions = _dimensions(_endX, _endY)
    _context.fillRect(start.x, start.y, dimensions.x, dimensions.y)

    // Draw the anchor
    _context.restore()
    _context.beginPath()
    _context.fillStyle = _isDragging ? 'rgba(20,200,80,0.5)' : 'rgba(0,80,250,0.3)'
    _context.arc(event.x, event.y, 10, 0, 2 * Math.PI)
    _context.fill()
  })

  _canvas.addEventListener('mouseup', (event) => {
    _isDragging = false
  })

  window.addEventListener('keydown', (event) => {
    if (event.ctrlKey) {
      _isRotating = true
    }
  })

  window.addEventListener('keyup', (event) => {
    _isRotating = false
  })

}
</script>  
</head>
<body>
<canvas id="canvas">
</canvas>  
</body>
</html>