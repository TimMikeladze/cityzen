<!DOCTYPE html>
<html>
<head>
<style>
body { margin: 0; overflow: hidden; }
canvas { background-color: #99ddaa; }
</style>
<script type="text/javascript">
window.onload = () => {
  'use strict'

  var _canvas = document.getElementById('canvas')
  var _context = _canvas.getContext('2d')
  var _isDragging = false
  var _isRotating = false
  var _startX
  var _startY
  var _endX
  var _endY
  var _rotation = Math.PI/10

  var _clearCanvas = () => {
    _canvas.width = _canvas.width
  }

  var _distance = (startX, startY, endX, endY) => {
    var diffX = Math.abs(startX - endX)
    var diffY = Math.abs(startY - endY)
    var distance = Math.sqrt(diffX * diffX + diffY * diffY)
    return distance
  }

  var _offset = () => {
    var d = _distance(0, 0, _startX, _startY)
    var theta = (Math.PI / 2 - _rotation / 2)
    var z = 2 * d * Math.cos(theta)
    var phi = Math.PI - theta - Math.acos(_startX / d)
    var x = z * Math.cos(phi)
    var y = z * Math.sin(phi)
    return {x:x,y:y}
  }


  /* Initialization */

  _canvas.height = window.innerHeight
  _canvas.width = window.innerWidth


  /* Event bindings */

  _canvas.addEventListener('mousedown', (event) => {
    _startX = event.x
    _startY = event.y
    _isDragging = true
  })

  _canvas.addEventListener('mousemove', (event) => {
    if (_isDragging) {
      _clearCanvas()
      if (_isRotating && _endX) {
        //TODO Alex
      } else {
        _endX = event.x
        _endY = event.y
      }
      _context.rotate(_rotation)
      _context.fillStyle = 'rgba(100,100,100,0.5)'
      var offset = _offset()
      var x = _startX + offset.x
      var y = _startY - offset.y
      _context.fillRect(x, y, _endX - _startX, _endY - _startY)
    }
  })

  _canvas.addEventListener('mouseup', (event) => {
    _isDragging = false
    _endX = undefined
    _endY = undefined
  })

  window.addEventListener('keydown', (event) => {
    if (event.ctrlKey) {
      _isRotating = true
    }
  })

  window.addEventListener('keyup', (event) => {
    _isRotating = false
  })

}
</script>  
</head>
<body>
<canvas id="canvas">
</canvas>  
</body>
</html>