<!DOCTYPE html>
<html>
<head>
<style>
body { margin: 0; overflow: hidden; }
canvas { background-color: #99ddaa; }
</style>
<script type="text/javascript">
window.onload = () => {
  'use strict'


  var Road = function (startX, startY) {
    this.startX = startX
    this.startY = startY
    this.endX = startX
    this.endY = startY
    this.rotation = 0
  }

  Road.prototype.project = function () {

    // Anchor
    var a = _distance(0, 0, this.startX, this.startY)
    var alpha = Math.PI / 2 - this.rotation / 2
    var b = 2 * a * Math.cos(alpha)
    var beta = Math.PI - alpha - Math.acos(this.startX / a)
    this.anchorX = this.startX + b * Math.cos(beta)
    this.anchorY = this.startY - b * Math.sin(beta)

    // Dimensions
    var c = _distance(this.startX, this.startY, this.endX, this.endY)
    var d = this.endX - this.startX
    var gamma = Math.acos(d / c)
    var orientation = (this.endY > this.startY) ? 1 : (this.endY == this.startY) ? 0 : -1
    var delta = gamma - this.rotation * orientation
    this.dimensionX = c * Math.cos(delta)
    this.dimensionY = c * Math.sin(delta) * orientation
  }


  var _canvas = document.getElementById('canvas')
  var _context = _canvas.getContext('2d')
  var _isDragging = false
  var _isRotating = false
  var _roads = []
  var _rotationStart
  var _rotationStartX
  var _rotationStartY

  var _clearCanvas = () => {
    _canvas.width = _canvas.width
  }

  var _distance = (startX, startY, endX, endY) => {
    var diffX = Math.abs(startX - endX)
    var diffY = Math.abs(startY - endY)
    var distance = Math.sqrt(diffX * diffX + diffY * diffY)
    return distance
  }

  var _resizeCanvas = () => {    
    _canvas.height = window.innerHeight
    _canvas.width = window.innerWidth
  }


  /* Initialization */

  _resizeCanvas()


  /* Event bindings */

  _canvas.addEventListener('mousedown', (event) => {
    _roads.push(new Road(event.x, event.y))
    _isDragging = true

    // Draw the anchor
    _clearCanvas()
    _context.fillStyle = 'rgba(20,200,80,0.5)'
    _context.arc(event.x, event.y, 10, 0, 2 * Math.PI)
    _context.fill()
  })

  _canvas.addEventListener('mousemove', (event) => {

    // If dragging, then update the current road
    if (_isDragging) {

      // Update the endpoint
      var road = _roads[_roads.length - 1]
      road.endX = event.x
      road.endY = event.y

      // Update the rotation
      if (_isRotating) {
        var rotationStartToRoadEnd = _distance(_rotationStartX, _rotationStartY, road.endX, road.endY)
        var roadStartToRotationStart = _distance(road.startX, road.startY, _rotationStartX, _rotationStartY)
        var roadStartToRoadEnd = _distance(road.startX, road.startY, road.endX, road.endY)
        var rotationDelta =
          Math.acos(
            (roadStartToRoadEnd * roadStartToRoadEnd +
             roadStartToRotationStart * roadStartToRotationStart -
             rotationStartToRoadEnd * rotationStartToRoadEnd) /
            (2 * roadStartToRoadEnd * roadStartToRotationStart)
          )
        var orientation = Math.sign(
          (_rotationStartX - road.startX) * (road.endY - road.startY) -
          (_rotationStartY - road.startY) * (road.endX - road.startX)
        )
        road.rotation = _rotationStart + rotationDelta * orientation
      }

      // Update the projection
      road.project()
    }

    // Draw the anchor
    _clearCanvas()
    _context.fillStyle = _isDragging ? 'rgba(20,200,80,0.5)' : 'rgba(0,80,250,0.3)'
    _context.arc(event.x, event.y, 10, 0, 2 * Math.PI)
    _context.fill()

    // Draw each road
    _roads.forEach((road) => {
      _context.rotate(road.rotation)
      _context.fillStyle = 'rgba(100,100,100,0.5)'
      _context.fillRect(
        road.anchorX, road.anchorY,
        road.dimensionX, road.dimensionY
      )
      _context.rotate(-road.rotation)
    })
  })

  _canvas.addEventListener('mouseup', (event) => {
    _isDragging = false
  })

  window.addEventListener('keydown', (event) => {
    if (_isDragging && event.ctrlKey) {
      var road = _roads[_roads.length - 1]
      _rotationStart = road.rotation
      _rotationStartX = road.endX
      _rotationStartY = road.endY
      _isRotating = true
    }
  })

  window.addEventListener('keyup', (event) => {
    _isRotating = false
  })

  window.addEventListener('resize', _resizeCanvas)

}
</script>  
</head>
<body>
<canvas id="canvas">
</canvas>  
</body>
</html>